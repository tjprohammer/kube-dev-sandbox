name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:
        inputs:
            registry_prefix:
                description: "Override the container registry prefix (defaults to repo variable or ghcr.io/<owner>)."
                required: false
            image_tag:
                description: "Override the image tag (defaults to short commit SHA)."
                required: false
            push_images:
                description: "Push built images to the registry."
                required: false
                default: "true"
                type: choice
                options:
                    - "true"
                    - "false"
            deploy_to_cluster:
                description: "Apply manifests with kubectl after pushing (requires kubeconfig secret)."
                required: false
                default: "false"
                type: choice
                options:
                    - "true"
                    - "false"

permissions:
    contents: read
    packages: write

jobs:
    lint-test:
        name: Lint & Tests
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python 3.12
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  python -m pip install -r services/api/requirements.txt -r services/notifications/requirements.txt
                  python -m pip install pyyaml

            - name: Static analysis
              run: |
                  python -m compileall services/api services/notifications
                  python .github/scripts/validate_manifests.py

    build-images:
        name: Build (and optionally push) images
        runs-on: ubuntu-latest
        needs: lint-test
        env:
            DEFAULT_REGISTRY_PREFIX: ${{ vars.REGISTRY_PREFIX || '' }}
            WORKFLOW_REGISTRY: ${{ inputs.registry_prefix || '' }}
            WORKFLOW_IMAGE_TAG: ${{ inputs.image_tag || '' }}
            WORKFLOW_PUSH_IMAGES: ${{ inputs.push_images || 'false' }}
            WORKFLOW_DEPLOY: ${{ inputs.deploy_to_cluster || 'false' }}
        outputs:
            registry-prefix: ${{ steps.meta.outputs.registry-prefix }}
            registry-host: ${{ steps.meta.outputs.registry-host }}
            image-tag: ${{ steps.meta.outputs.image-tag }}
            should-push: ${{ steps.meta.outputs.should-push }}
            should-deploy: ${{ steps.meta.outputs.should-deploy }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Resolve build metadata
              id: meta
              run: |
                  set -euo pipefail
                  registry_prefix="$WORKFLOW_REGISTRY"
                  if [ -z "$registry_prefix" ]; then
                    registry_prefix="$DEFAULT_REGISTRY_PREFIX"
                  fi
                  if [ -z "$registry_prefix" ]; then
                    registry_prefix="ghcr.io/${{ github.repository_owner }}"
                  fi

                  if [[ "$registry_prefix" != */* ]]; then
                    echo "Registry prefix must include both host and namespace (example: ghcr.io/your-namespace)." >&2
                    exit 1
                  fi

                  image_tag="$WORKFLOW_IMAGE_TAG"
                  if [ -z "$image_tag" ]; then
                    image_tag="${GITHUB_SHA::7}"
                  fi

                  should_push=false
                  if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
                    should_push=true
                  elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "$WORKFLOW_PUSH_IMAGES" = "true" ]; then
                    should_push=true
                  fi

                  should_deploy=false
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "$WORKFLOW_DEPLOY" = "true" ]; then
                    should_deploy=true
                  fi

                  registry_host="${registry_prefix%%/*}"

                  printf 'registry-prefix=%s\n' "$registry_prefix" >> "$GITHUB_OUTPUT"
                  printf 'registry-host=%s\n' "$registry_host" >> "$GITHUB_OUTPUT"
                  printf 'image-tag=%s\n' "$image_tag" >> "$GITHUB_OUTPUT"
                  printf 'should-push=%s\n' "$should_push" >> "$GITHUB_OUTPUT"
                  printf 'should-deploy=%s\n' "$should_deploy" >> "$GITHUB_OUTPUT"

            - name: Log in to registry
              if: steps.meta.outputs.should-push == 'true'
              uses: docker/login-action@v3
              with:
                  registry: ${{ steps.meta.outputs.registry-host }}
                  username: ${{ secrets.REGISTRY_USERNAME }}
                  password: ${{ secrets.REGISTRY_TOKEN }}

            - name: Build images
              run: |
                  make build REGISTRY=${{ steps.meta.outputs.registry-prefix }} IMAGE_TAG=${{ steps.meta.outputs.image-tag }}

            - name: Push images
              if: steps.meta.outputs.should-push == 'true'
              run: |
                  make push REGISTRY=${{ steps.meta.outputs.registry-prefix }} IMAGE_TAG=${{ steps.meta.outputs.image-tag }}

    deploy:
        name: Deploy to cluster
        runs-on: ubuntu-latest
        needs: build-images
        if: needs.build-images.outputs.should-deploy == 'true'
        env:
            REGISTRY_PREFIX: ${{ needs.build-images.outputs.registry-prefix }}
            IMAGE_TAG: ${{ needs.build-images.outputs.image-tag }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Configure kubectl
              env:
                  KUBECONFIG_B64: ${{ secrets.SANDBOX_KUBECONFIG_B64 }}
              run: |
                  set -euo pipefail
                  if [ -z "$KUBECONFIG_B64" ]; then
                    echo "The SANDBOX_KUBECONFIG_B64 secret is required to deploy." >&2
                    exit 1
                  fi
                  mkdir -p ~/.kube
                  echo "$KUBECONFIG_B64" | base64 --decode > ~/.kube/config

            - name: Apply manifests
              run: |
                  make apply-app REGISTRY=$REGISTRY_PREFIX IMAGE_TAG=$IMAGE_TAG
                  make apply-gateway
                  make apply-monitoring
                  make set-images REGISTRY=$REGISTRY_PREFIX IMAGE_TAG=$IMAGE_TAG
                  kubectl rollout status deployment/api -n sandbox-app --timeout=120s
                  kubectl rollout status deployment/notifications -n sandbox-app --timeout=120s
